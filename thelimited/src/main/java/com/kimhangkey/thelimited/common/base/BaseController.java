package com.kimhangkey.thelimited.common.base;

import java.io.File;
import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Iterator;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;
import org.springframework.web.servlet.ModelAndView;

import com.kimhangkey.thelimited.goods.vo.ImageFileVO;

public abstract class BaseController {
	
	private static final String CURR_IMAGE_REPO_PATH = "D:\\thelimited\\file_repo";
	
	
	@RequestMapping(value = "*.do")
	public ModelAndView viewForm(HttpServletRequest request, HttpServletResponse response) throws Exception{
		
		ModelAndView mav = new ModelAndView();
		String viewName=(String)request.getAttribute("viewName");
		mav.setViewName(viewName);
		System.out.println(viewName);
		return mav;
	}
	
	
	// 관리자, 마이페이지에서 공통으로 사용될 버튼식조회 기간설정 메소드
		protected String calcSearchPeriod(String fixedSearchPeriod){
			String beginDate=null;
			String endDate=null;
			String endYear=null;
			String endMonth=null;
			String endDay=null;
			String beginYear=null;
			String beginMonth=null;
			String beginDay=null;
			DecimalFormat df = new DecimalFormat("00");
			Calendar cal=Calendar.getInstance();
			
			endYear   = Integer.toString(cal.get(Calendar.YEAR));
			endMonth  = df.format(cal.get(Calendar.MONTH) + 1);
			endDay   = df.format(cal.get(Calendar.DATE));
			endDate = endYear +"-"+ endMonth +"-"+endDay;
			
			//별다른 지정이 없을경우, 1개월
			if(fixedSearchPeriod == null) {
				cal.add(cal.MONTH, -1);
			}else if(fixedSearchPeriod.equals("today")) {
				cal.add(Calendar.DAY_OF_YEAR,-0);
			}else if(fixedSearchPeriod.equals("one_month")) {
				cal.add(cal.MONTH, -1);
			}else if(fixedSearchPeriod.equals("two_month")) {
				cal.add(cal.MONTH,-2);
			}else if(fixedSearchPeriod.equals("three_month")) {
				cal.add(cal.MONTH,-3);
			}else if(fixedSearchPeriod.equals("six_month")) {
				cal.add(cal.MONTH,-6);
			}
			
			beginYear   = Integer.toString(cal.get(Calendar.YEAR));
			beginMonth  = df.format(cal.get(Calendar.MONTH) + 1);
			beginDay   = df.format(cal.get(Calendar.DATE));
			beginDate = beginYear +"-"+ beginMonth +"-"+beginDay;
			
			return beginDate+","+endDate;
		}
		
		//상품추가/수정시 사용될 파일 upload메소드, fileList return
		protected List<ImageFileVO> upload(MultipartHttpServletRequest multipartRequest) throws Exception{
			List<ImageFileVO> fileList= new ArrayList<ImageFileVO>();
			Iterator<String> fileNames = multipartRequest.getFileNames();
			
			while(fileNames.hasNext()){
				ImageFileVO imageFileVO =new ImageFileVO();
				String fileName = fileNames.next();
				imageFileVO.setFileType(fileName);
				MultipartFile mFile = multipartRequest.getFile(fileName);
				String originalFileName=mFile.getOriginalFilename();
				
				// detail 이미지 미추가시 걸러준다.
				if(fileName.equals("main_image") || (originalFileName != "" && originalFileName != null)) {
					imageFileVO.setFileName(originalFileName);
					fileList.add(imageFileVO);
					
					File file = new File(CURR_IMAGE_REPO_PATH +"\\"+ fileName);
					if(mFile.getSize()!=0){ //File Null Check
						if(! file.exists()){ //경로상에 파일이 존재하지 않을 경우
							if(file.getParentFile().mkdirs()){ //경로에 해당하는 디렉토리들을 생성
								file.createNewFile(); //이후 파일 생성
							}
						}
						mFile.transferTo(new File(CURR_IMAGE_REPO_PATH +"\\"+"temp"+ "\\"+originalFileName)); //임시로 저장된 multipartFile을 실제 파일로 전송
					}
				}
			}
			return fileList;
		}
}
